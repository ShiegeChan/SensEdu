---
title: EMG BioInputs
layout: default
parent: Projects
math: mathjax
nav_order: 4
---

# EMG BioInputs
{: .fs-8 .fw-500 .no_toc}
---

- TOC
{:toc}

## Introduction

[Electromyography](https://en.wikipedia.org/wiki/Electromyography) (EMG) is a widely-used technique for recording and analyzing electrical activities generated by skeletal muscles.

EMG is appealing due to its simplicity when detecting basic movements, such as a biceps contraction. For such projects, advanced hardware or complex signal processing is often unnecessary. This makes EMG an accessible tool for beginners as an introduction into biomedical engineering projects. Furthermore, the foundational concepts learned through EMG can be extended to related fields, including [Electrocardiography](https://en.wikipedia.org/wiki/Electrocardiography) (ECG), [Electrooculography](https://en.wikipedia.org/wiki/Electrooculography) (EOG), [Electroencephalography](https://en.wikipedia.org/wiki/Electroencephalography) (EEG), and others.

In SensEdu, we demonstrate how basic biceps contraction can be used to simulate keyboard press logic, with latency of ~100–200ms. We use the most basic circuit design combined with signal processing in MATLAB.

This page will guide you step-by-step through the required setup and knowledge to create a simple yet effective demonstration of a typical biomedical engineering project.

## Biological Background

First, we need to establish an understanding of what we are trying to measure.

{: .TIP}
Highly recommended watching the video [Neuromuscular Junction](https://youtu.be/_k6QINRcdV4?si=TG5Yw0wvDcTJtR6G) by [Byte Size Med].

The most important structure that we need to focus on is the [Neuromuscular Junction](https://en.wikipedia.org/wiki/Neuromuscular_junction) (NMJ). This is a specialized [synapse](https://en.wikipedia.org/wiki/Synapse) that acts as a communication bridge between [motor neurons](https://www.simplypsychology.org/motor-neuron.html) and skeletal muscle fibers. The NMJ plays a fundamental role in converting neural signals into muscle contraction. Let's break down its working principle step by step.

The process begins with a motor neuron transmitting an electrical signal called an [Action Potential]. This signal travels along neuron's [axon](https://en.wikipedia.org/wiki/Axon) until it reaches the NMJ. It activates **voltage-gated sodium channels**, which allow positively charged sodium ions (Na⁺) enter the cell. The influx of sodium causes the cell membrane to become *"less negatively charged"*, a change known as **depolarization**.

Continuous depolarization of the cell membrane subsequently activates **voltage-gated calcium channels**. Calcium ions (Ca²⁺) flow into the cell which triggers [little containers](https://en.wikipedia.org/wiki/Synaptic_vesicle) with [neurotransmitters](https://en.wikipedia.org/wiki/Neurotransmitter) to fuse with the membrane and release [Acetylcholine](https://en.wikipedia.org/wiki/Acetylcholine) (ACh).

<img src="{{site.baseurl}}/assets/images/NMJ1.png"/>
{: .text-center .mb-1}

[Exocytosis](https://en.wikipedia.org/wiki/Exocytosis) process at the Neuromuscular Junction (source: [Byte Size Med])
{: .text-center .mt-0 .fw-500}

Acetylcholine travels across the synaptic space and binds to specialized receptors on the muscle cell's membrane. These receptors, also known as [ligand-gated ion channels](https://en.wikipedia.org/wiki/Ligand-gated_ion_channel), respond to the chemical messenger (neurotransmitter) by opening and allowing ions to enter the muscle cell. This process triggers membrane **depolarization**, causing the resting membrane potential of the muscle cell (normally at around -90mV) to become less negative.

<img src="{{site.baseurl}}/assets/images/NMJ2.png"/>
{: .text-center .mb-1}

[Depolarization](https://en.wikipedia.org/wiki/Depolarization) caused by the opening of ligand-gated ion channels (source: [Byte Size Med])
{: .text-center .mt-0 .fw-500}

As more ACh molecules bind to their receptors, the membrane voltage continues to rise. Once it reaches a threshold of approximately -50 mV, **voltage-gated sodium channels** open, allowing sodium ions (Na⁺) to rush into the muscle cell. This influx of sodium completes the process of membrane depolarization and generates an **Action Potential**. This electrical signal propagates along the muscle membrane, eventually leading to a muscle contraction.

<img src="{{site.baseurl}}/assets/images/NMJ3.png"/>
{: .text-center .mb-1}

[Excitation-Contraction Coupling](https://www.sciencedirect.com/topics/medicine-and-dentistry/excitation-contraction-coupling) (source: [Byte Size Med])
{: .text-center .mt-0 .fw-500}

{: .NOTE}
If you feel overwhelmed by the details, the main takeaway: a neural electrical signal is converted to a chemical signal and then back into electrical signal in the muscle. The sequence **Neural Action Potential** → **Acetylcholine Release** → **Muscle Action Potential**. The muscle action potential then propagates along the muscle cell membrane and ultimately triggers muscle contraction.<br><br>The most important point is that this **muscle action potential can be measured**, providing valuable information about muscle activity.

## Recording Action Potentials

Action Potentials can be recorded using different methods:
* **Invasive Needle EMG**: Inserting electrodes directly into the muscle, enabling highly precise and localized recordings. It is widely used in clinical applications and treatments where precision and measurement quality are critical.
* **Non-invasive Surface EMG**: Placing electrodes on the skin above the muscle. This approach improves patient comfort and simplifies repeatable studies, making it ideal for educational purposes. However, sEMG has significant precision **limitations due to the layers of skin and fat** between the electrodes and the muscle. These limitations make it challenging to differentiate the activity of individual muscle fibers and to record signals from small muscles, like ones around the fingers.

{: .NOTE}
In SensEdu we use surface EMG. From now on, whenever we mention EMG or electrodes, we are referring to sEMG and surface electrodes, respectively.

## Hardware Setup

This section describes the necessary connections and hardware details required for the proper setup of the EMG BioInputs system and writing the script for MCU. Below is an illustration of the overall system architecture.

<img src="{{site.baseurl}}/assets/images/EMG_Block.png"/>
{: .text-center .mb-1}

EMG BioInputs System Architecture
{: .text-center .mt-0 .fw-500}

### Electrodes Connectivity

The system supports **up to 4 EMG probes**, which can be connected via female 4-Pin 2.54 headers: **J9**, **J11**, **J12**, and **J20**. 

<img src="{{site.baseurl}}/assets/images/EMG_Headers.png"/>
{: .text-center .mb-1}

SensEdu input headers (red dots mark the 1st pin)
{: .text-center .mt-0 .fw-500}

A typical electrode consists of 3 connectors: **Reference**, **Positive Input**, and **Negative Input**. Below is a table detailing how these connectors correspond to the pins on the headers. Note that the voltage pin (1st pin) on the headers is not used in this connection.

| Electrode Connector | Signal | Header Pin |
|:--------------------|:-------|:-----------|
| Negative Input      |   –IN  | 2nd Pin    |
| Positive Input      |   +IN  | 3rd Pin    |
| Reference           |   GND  | 4th Pin    |

{: .WARNING}
Most commercially available electrodes use connectors that are not directly compatible with typical 2.54 headers. For specific chosen electrode you will need a solution how to make this connection possible via soldering, custom adapters, or ready-made solutions.

In our example, we used the following electrodes:

| Manufacturer | Product Title | Product Code | Datasheet | Store |
|:-------------|:--------------|:-------------|:----------|:------|
| SparkFun Electronics | Electrode Pads | 12970 | [link](https://mm.digikey.com/Volume0/opasdata/d220001/medias/docus/2277/CAB-12970_Web.pdf) | [link](https://www.digikey.at/de/products/detail/sparkfun-electronics/12970/6833933?gclsrc=aw.ds&gad_source=1&gad_campaignid=20265439570&gclid=CjwKCAjwqKzEBhANEiwAeQaPVawVKSgXTIiVYtlIXGx7Bx94wvNKO64lkmGlu8jQ0lByNxnXmPGLFhoCgNcQAvD_BwE) |
| MTG Imiella Medizintechnik | Liquid Gel Disposable Electrodes for ECG (Ø40mm) | S40LG | [link](https://static.mercateo.com/ec/2c36d66dd9904e92ad9e3075734affb2/pdf/106366.pdf?v=2297) | [link](https://www.mercateo.at/p/2768-028002/Einmal_Klebeelektroden_40_mm_Liquid_Gel_30_Stueck.html) |

These electrodes use a mini-jack connector. To simplify the connection, we designed a simple PCB adapter called **MiniJack2Jumper**. This adapter is inserted vertically into the SensEdu header, providing a mini-jack socket and eliminating the need for soldering. All PCB source files, including Gerbers and BOM, are available in the directory: `/Projects/EMG-BioInputs/pcbs/MiniJack2Jumper`. To replicate our setup, you can use archive `MiniJack2Jumper/manufacturing/MiniJack2Jumper-Gerber.zip` to order the PCB from any cheap Chinese manufacturer. The cost typically ranges from $15–$30 depending on shipping.

<img src="{{site.baseurl}}/assets/images/EMG_MiniJack2Jumper.png"/>
{: .text-center .mb-1}

MiniJack2Jumper adapter: Schematics, PCB view, 3D view, and real-life view
{: .text-center .mt-0 .fw-500}

After connecting the electrodes using the MiniJack2Jumper adapter, the final setup looks as follows:

<img src="{{site.baseurl}}/assets/images/EMG_Electrode_Connection.png"/>
{: .text-center .mb-1}

Electrode connection to SensEdu
{: .text-center .mt-0 .fw-500}

### Amplifier Circuit

Refering to the system architecture, the first step right after input electrodes is signal amplification. As a base SensEdu offers x2 Dual-Channel Instrumentation Amplifiers [AD8222](https://www.analog.com/media/en/technical-documentation/data-sheets/ad8222.pdf). 

<img src="{{site.baseurl}}/assets/images/EMG_Amp_Circuit.png"/>
{: .text-center .mb-1}

Instrumentation Amplifier AD8222 Circuit
{: .text-center .mt-0 .fw-500}

Gain is set by $$R_G$$ resistor with the following formula:

$$G = 1 + \frac{49.4kΩ}{R_G} = 1 + \frac{49.4kΩ}{1kΩ} = 50.4$$

Series resistance protects amplifier from overvoltage and additional filtering is used to avoid high frequency rectification into the amplifier and thus signal distortion. The filter limits the input signal bandwidth according to the following relationship:

$${f_c}_{DIFF} = \frac{1}{2\pi × R(2C_D + C_C)} = \frac{1}{2\pi × 3.9kΩ(2×470pF + 100pF)} = 37.7kHz$$

$${f_c}_{CM} = \frac{1}{2\pi × R × C_C} = \frac{1}{2\pi × 3.9kΩ × 100pF} = 392.2kHz$$

{: .NOTE}
Mismatch between the R × CC at the positive input and the R × CC at 
negative input degrades the CMRR of the AD8222. By using a value of ~ CD 10× larger than the value of CC, the effect of the mismatch is reduced and performance is improved.

We left the $${f_c}_{DIFF}$$ and $${f_c}_{CM}$$ values in stock values for all projects, but reducing these cut frequencies clother to working low frequency of EMG up to ~500Hz could improve signal quality.

For writing arduino script you need to know how these amplifiers wired internally, to which header and which ADC channel. You can get this information from schematics and ADC summary table, but below you can find everything extracted in one place:
* J9: 1st Channel of U5 → outputs MIC5 - A0 - ADC12_INP4
* J11: 2nd Channel of U5 → outputs MIC6 - A2 - ADC12_INP9
* J12: 1st Channel of U6 → outputs MIC7 - A11 - ADC12_INP0
* J20: 2nd Channel of U6 → outputs MIC8 - A7 - ADC1_INP16

### ADC Configuration

Give here details about ADCs for Arduino sketch.



SensEdu Amplification Circuit
{: .text-center .mt-0 .fw-500}

Amplifier, script, basic circuit, converter, all required elements

### Data transfer

Page 2747 Figure 793 of [STM32H747 Reference Manual] OTG_FS and USB0 at [Arduino GIGA R1 Schematics].

## Signal Processing

MATLAB magic

## Testing

## Showcase

## Possible improvements

## Sources

## Appendix: data recordings for improvements


SensEdu is equipped with x2 [AD8222] Instrumentation Amplifier ([datasheet]).

Each Amplifier is dual-channel, so we have 4 channels in total. All channels are accessible from the following Jumpers:
* J9: 1st Channel of U5 → outputs MIC5 - A0 - ADC12_INP4
* J11: 2nd Channel of U5 → outputs MIC6 - A2 - ADC12_INP9
* J12: 1st Channel of U6 → outputs MIC7 - A11 - ADC12_INP0
* J20: 2nd Channel of U6 → outputs MIC8 - A7 - ADC1_INP16

Refer to the [ADC mapping table](/SensEdu/Library/ADC/#adc_mapping) for better understanding.

Circuit for each of the amplifier:

<img src="{{site.baseurl}}/assets/images/amp_circuit.png"/>
{: .text-center}

Electrode mapping:
* Tip: Red
* Ring: Blue
* Sleeve: Black

## Test

WASD Dark Souls for 4 channels?

## Capacitive input
ignore some of the first samples for ADC stabilization

https://devzone.nordicsemi.com/f/nordic-q-a/80796/adc---first-read-is-always-wrong/336435

## History
A 1-second history allows the filter to capture multiple cycles of low-frequency components, such as 10Hz (1 cycle every 100ms) or even lower frequencies (e.g., motion artifacts below 10Hz). This improves:

The filter's ability to attenuate noise and artifacts.
The preservation of desired signal components, especially in the lower frequency band.

A longer history allows low-pass filters (used in envelope detection) to smooth the rectified signal over a larger time frame, resulting in a more robust and stable envelope.
For example, a 5Hz low-pass filter requires at least 200ms of data for one full cycle. With a 1-second history, the envelope will be less sensitive to short-term fluctuations or noise.

 Sliding Overlapping Windows

Use a 1-second buffer for filtering and envelope detection, but process overlapping chunks (e.g., update every 40ms). This ensures that decisions are updated frequently without sacrificing the filtering accuracy of the longer window.

## Good study on perfect high pass value
https://www.bu.edu/nmrc/files/2010/06/103.pdf

## Good Resources:
* https://www.nature.com/articles/s41597-022-01484-2

## Sources:
* https://youtu.be/_k6QINRcdV4?si=rnil7B-ZlqmRCGSN
* https://youtu.be/ApaPlKPb4ek?si=rHncr0b2XipqN83i

## Improvements
* Implement filtering in hardware, you can extend SensEdu with another custom shield which will make half of current signal processing unnecessary greatly reducing latency and required computations. In addition, use right leg drive to decrease noise and offset.
* mkm

[Byte Size Med]: https://www.youtube.com/channel/UCZghvlgylH3r_CWfA18eFRg
[Action Potential]: (https://en.wikipedia.org/wiki/Action_potential)
[AD8222]: https://www.analog.com/en/products/ad8222.html?doc=ad8222-KGD.pdf
[datasheet]: https://www.analog.com/media/en/technical-documentation/data-sheets/AD8222.pdf
[STM32H747 Reference Manual]: https://www.st.com/resource/en/reference_manual/rm0399-stm32h745755-and-stm32h747757-advanced-armbased-32bit-mcus-stmicroelectronics.pdf

[Arduino GIGA R1 Schematics]: https://docs.arduino.cc/resources/schematics/ABX00063-schematics.pdf